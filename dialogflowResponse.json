{
    "responseId": "75cbe7c7-4600-4888-a0ac-a35928e8d64d",
    "queryResult": {
      "queryText": "John",
      "action": "input.ask_name",
      "parameters": {
        "name": "John"
      },
      "allRequiredParamsPresent": true,
      "fulfillmentText": "Welcome to our bank John",
      "fulfillmentMessages": [
        {
          "text": {
            "text": [
              "Welcome to our bank John"
            ]
          }
        }
      ],
      "intent": {
        "name": "projects/dialogflowv2test-212707/agent/intents/b507fc15-554c-4090-9384-69210217fdd3",
        "displayName": "ask_name"
      },
      "intentDetectionConfidence": 1,
      "diagnosticInfo": {
        "webhook_latency_ms": 20
      },
      "languageCode": "en"
    },
    "webhookStatus": {
      "message": "Webhook execution successful"
    },
    "outputAudio": "UklGRjxlAQBXQVZFZm10IBAAAAABAAEAwF0AAIC7AAACABAAZGF0YRhlAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA... (The content is truncated. Click `COPY` for the original JSON.)",
    "outputAudioConfig": {
      "audioEncoding": "OUTPUT_AUDIO_ENCODING_LINEAR_16",
      "synthesizeSpeechConfig": {
        "speakingRate": 1,
        "voice": {}
      }
    }
  }

  "outputAudioConfig": {
    "audioEncoding": "OUTPUT_AUDIO_ENCODING_LINEAR_16",
    "synthesizeSpeechConfig": {
      "speakingRate": 1,
      "voice": {
        "name": "female_enIN",
        "ssmlGender": "SSML_VOICE_GENDER_FEMALE"
      }
    }
  }



  const firebase = require("firebase-functions");
var request, response, parameters;
var outputAudiocnfg = {
    "audioEncoding": "OUTPUT_AUDIO_ENCODING_LINEAR_16",
    "synthesizeSpeechConfig": {
      "speakingRate": 1,
      "voice": {
        "name": "female_enIN",
        "ssmlGender": "SSML_VOICE_GENDER_FEMALE"
      }
    }
  }
exports.dialogflowFirebaseFulfillment = firebase.https.onRequest((req,res) => {
    request =req;
    response = res;
    parameters = req.body.queryResult.parameters;
    res.body.outputAudioConfig = outputAudiocnfg;
    console.log("Test bot Request headers " + JSON.stringify(request.headers));
    console.log("Tes bot Request Body " + JSON.stringify(request.body));
    console.log("The bot response object is " + JSON.stringify(response.body));

    if(request.body.queryResult){
        processV2Request();

    }else{
        console.log("Invalid Request");
        return response.status(400).end('Invalid Webhook Requset');
    }
});

    const intentHandlers = {
        'input.welcome' : () => {
            sendResponse('Hello, Welcome to the Test Bot. Please Enter your Pin');
        },
        'input.unknown' : () => {
            sendResponse('You have to enter a number sequesnce for pin and/or proper name');
        },
        'input.ask_name' : () => {
            //parameters = request.body.queryResult.parameters;
            //console.log(parameters.name);
            sendResponse('Welcome to our bank ' + parameters.name );
        },

        'input.pin' : () => {
            //sendResponse("You have entered some pin");
             
             //console.log("The query result parameter are" + parameters);
            if(validatePin(parameters.pin)){
                //if the input pin is one of from valid_pin then ask for other name
                sendResponse("The pin is correct. What is your name?");
            }else{
                // or call the default intent
                //sendInvalidPin('Invalid pin, please try again');
                sendResponse("Please retype your pin");
            }
        },
        
        'default' : () => { 
            sendResponse("Please follow the sequence");
        }
        
    };

    const valid_pin = [
        { 
            'pin' : '1234'
        },
        {
            'pin' : '4567'
        }

    ];

    function validatePin(pin){
        let lpin = pin;
        if(lpin === 1234){
            return true;
        }else{
            return false;
        }

        
    }

    function sendResponse(responseToUser){
        let responseJson = {fulfillmentText : responseToUser};
        console.log("Response to the User is " + JSON.stringify(responseJson));
        response.json(responseJson);
    }

    function processV2Request(){
        let action = (request.body.queryResult.action) ? request.body.queryResult.action : 'default';

        if(intentHandlers[action]){
            intentHandlers[action]();
        }else{
            intentHandlers['default']();
        }
    }
